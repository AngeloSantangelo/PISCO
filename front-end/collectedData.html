<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard con Grafico</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 id="dashboard" class="text-center mb-4"></h2>

  <!-- Contenitore per i grafici -->
  <div id="chartContainer" class="row"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const sensor1String = localStorage.getItem("sensor1");
const sensor1 = JSON.parse(sensor1String);

if(sensor1){
  fetchData(sensor1.idSensor);
}

async function fetchData(idSensor) {  
  try {
    const response = await fetch('http://localhost:7071/api/findDataByIdSensor', {
      method: 'POST',
      body: JSON.stringify({ idSensor }),
    });

    const data = await response.json();
    const nomiMesi = [
      'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
      'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
    ];

    const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const labels = [];
    const weeksData = {};

    // mese attuale (quello di sistema)
    const actualDate = new Date();
    const actualMonthIndex = actualDate.getMonth();
    const actualMonth = nomiMesi[actualMonthIndex];

    const dashboard = document.getElementById("dashboard");
    const text = document.createTextNode('Dashboard mese di '+ actualMonth);
    dashboard.appendChild(text);

    const filteredData = data.collectedData.filter(collectedData => {
      const date = new Date(collectedData.date);
      return date.getMonth() === actualMonthIndex;
    });

    filteredData.forEach(filteredData => {
      const date = new Date(filteredData.date);
      const weekNumber = getWeekNumber(date);

      if (!weeksData[weekNumber]) {
        weeksData[weekNumber] = [];
      }

      weeksData[weekNumber].push(filteredData);
    });

    for (const weekNumber in weeksData) {
      const weekData = weeksData[weekNumber];
      const weekLabels = daysOfWeek.map(day => `${day}`);
      const maxPeopleNumbers = {};

      weekData.forEach(filteredData => {
        const date = new Date(filteredData.date);
        const dayOfWeek = getDayOfWeek(daysOfWeek, date.getDay());
        const key = `${dayOfWeek}`;

        if (!maxPeopleNumbers[key] || filteredData.peopleNumber > maxPeopleNumbers[key]) {
          maxPeopleNumbers[key] = filteredData.peopleNumber;
        }
      });

      const peopleNumbers = weekLabels.map(label => maxPeopleNumbers[label] || 0);
      updateChart(weekNumber, weekLabels, peopleNumbers);
    }
  } catch (error) {
    console.error(error);
  }
}

function getWeekNumber(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}

function getWeekRange(weekNumber) {
  const startDate = new Date('2024-01-01');
  startDate.setDate(startDate.getDate() + (weekNumber - 1) * 7);

  const endDate = new Date(startDate);
  endDate.setDate(endDate.getDate() + 6);

  const startDay = startDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'long' });
  const endDay = endDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'long' });

  return `${startDay} - ${endDay}`;
}

function getDayOfWeek(daysOfWeek, dayIndex) {
  return daysOfWeek[dayIndex];
}

function updateChart(weekNumber, labels, peopleNumbers) {
  // elemento div per il grafico
  const chartContainer = document.getElementById('chartContainer');
  const chartDiv = document.createElement('div');
  const weekRange = getWeekRange(weekNumber);
  chartDiv.className = 'col-md-6'; 
  chartDiv.innerHTML = `<div class="card">
                          <div class="card-body">
                            <h5 class="card-title">${weekNumber}Â° Settimana ---- ${weekRange}</h5>
                            <canvas id="myChart${weekNumber}" width="600" height="400"></canvas>
                          </div>
                        </div>`;
  chartContainer.appendChild(chartDiv);

  
  const ctx = document.getElementById(`myChart${weekNumber}`).getContext('2d');
  const myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'People Number',
        data: peopleNumbers,
        fill: false,
        borderColor: '#003b6e',
        borderWidth: 2
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'People Number'
          },
        }
      }
    }
  });
}
</script>

</body>
</html>
